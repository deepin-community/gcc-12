From c02e028eb1f917e3d6297ea32fb3ac6520371f08 Mon Sep 17 00:00:00 2001
From: Lulu Cheng <chenglulu@loongson.cn>
Date: Fri, 12 Jan 2024 17:06:30 +0800
Subject: [PATCH 226/301] LoongArch: Assign the '/u' attribute to the mem to
 which the global offset table belongs.

gcc/ChangeLog:

	* config/loongarch/loongarch.cc (loongarch_split_symbol):
	Assign the '/u' attribute to the mem.

gcc/testsuite/ChangeLog:

	* g++.target/loongarch/got-load.C: New test.
---
 src/gcc/config/loongarch/loongarch.cc         |  5 +++++
 .../testsuite/g++.target/loongarch/got-load.C | 19 +++++++++++++++++++
 2 files changed, 24 insertions(+)
 create mode 100644 src/gcc/testsuite/g++.target/loongarch/got-load.C

diff --git a/src/gcc/config/loongarch/loongarch.cc b/src/gcc/config/loongarch/loongarch.cc
index d27176028..ac9b68bb4 100644
--- a/src/gcc/config/loongarch/loongarch.cc
+++ b/src/gcc/config/loongarch/loongarch.cc
@@ -3198,6 +3198,11 @@ loongarch_split_symbol (rtx temp, rtx addr, machine_mode mode, rtx *low_out)
 	      rtx mem = gen_rtx_MEM (Pmode, low);
 	      *low_out = gen_rtx_UNSPEC (Pmode, gen_rtvec (1, mem),
 					 UNSPEC_LOAD_FROM_GOT);
+
+	      /* Nonzero in a mem, if the memory is statically allocated and
+		 read-only.  A common example of the later is a shared libraryâ€™s
+		 global offset table.  */
+	      MEM_READONLY_P (mem) = 1;
 	    }
 
 	  break;
diff --git a/src/gcc/testsuite/g++.target/loongarch/got-load.C b/src/gcc/testsuite/g++.target/loongarch/got-load.C
new file mode 100644
index 000000000..20924c739
--- /dev/null
+++ b/src/gcc/testsuite/g++.target/loongarch/got-load.C
@@ -0,0 +1,19 @@
+/* { dg-do compile } */
+/* { dg-options "-mabi=lp64d -O2 -mexplicit-relocs -mcmodel=normal -fdump-rtl-expand" } */
+/* { dg-final { scan-rtl-dump-times "mem/u" 2 "expand" } } */
+
+#include <bits/stdc++.h>
+
+using namespace std;
+
+int lr[100005][2];
+
+void
+test(void)
+{
+  int n;
+
+  cin >> n;
+  for (int i = 0; i < n; ++i)
+    cin >> lr[i][0] >> lr[i][1];
+}
-- 
2.45.2

